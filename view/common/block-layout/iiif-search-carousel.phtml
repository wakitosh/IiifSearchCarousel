<?php
// $rows, $ratioDefault, $ratioSm, $ratioMd, $bpSm, $bpMd, $duration, $blockId, $customCss, $resourceTargets, $trimTop, $trimRight, $trimBottom, $trimLeft, $showSearch
// Resource targets: items / media / item_sets
$controllerMap = [
  'items' => 'item',
  'media' => 'media',
  'item_sets' => 'item-set',
];
$initialTarget = is_array($resourceTargets) && $resourceTargets ? $resourceTargets[0] : 'items';
$controller = $controllerMap[$initialTarget] ?? 'item';
$searchAction = $this->url('site/resource', ['controller' => $controller, 'action' => 'browse'], true);
$searchValue = $this->escapeHtml($this->params()->fromQuery('search', ''));
// Locale for overlay search form (ja vs others)
$__locale = (string) $this->lang();
$__isJa = (strpos($__locale, 'ja') === 0);
$__placeholder = $__isJa ? 'キーワード' : 'Search...';
$__buttonLabel = $__isJa ? '検索' : 'Search';

// Ensure truncateLen is defined (0 disables truncation)
$truncateLen = isset($truncateLen) ? (int) $truncateLen : 0;

// Helper: truncate title safely (UTF-8). 0 = no truncation.
$__truncate = function ($s) use ($truncateLen) {
  $s = (string) $s;
  $n = (int) ($truncateLen ?? 0);
  if ($n <= 0) return $s;
  if (function_exists('mb_strlen') && function_exists('mb_substr')) {
    return (mb_strlen($s, 'UTF-8') > $n)
      ? (mb_substr($s, 0, $n, 'UTF-8') . '…')
      : $s;
  }
  return (strlen($s) > $n) ? (substr($s, 0, $n) . '…') : $s;
};

// Helper: format a percentage with up to 1 decimal without trailing .0
$__fmtPct = function ($v) {
  $v = (float) $v;
  $s = number_format($v, 1, '.', '');
  if (substr($s, -2) === '.0') {
    return substr($s, 0, -2);
  }
  return $s;
};

// Precompute region if any trim set
$__hasTrim = ($trimTop > 0 || $trimRight > 0 || $trimBottom > 0 || $trimLeft > 0);
$__region = null;
if ($__hasTrim) {
  $x = max(0.0, (float) $trimLeft);
  $y = max(0.0, (float) $trimTop);
  $w = max(0.1, 100.0 - (float) $trimLeft - (float) $trimRight);
  $h = max(0.1, 100.0 - (float) $trimTop - (float) $trimBottom);
  $__region = 'pct:' . $__fmtPct($x) . ',' . $__fmtPct($y) . ',' . $__fmtPct($w) . ',' . $__fmtPct($h);
}
?>
<section class="iiif-sc" id="iiif-sc-<?php echo (int) $blockId; ?>">
  <style>
    /* Scoped responsive aspect ratios for this block */
    #iiif-sc-<?php echo (int) $blockId; ?> .iiif-sc__bg { aspect-ratio: <?php echo $this->escapeHtml($ratioDefault); ?>; }
<?php if (!empty($ratioMd) && !empty($bpMd)): ?>
    @media (max-width: <?php echo (int) $bpMd; ?>px) {
      #iiif-sc-<?php echo (int) $blockId; ?> .iiif-sc__bg { aspect-ratio: <?php echo $this->escapeHtml($ratioMd); ?>; }
    }
<?php endif; ?>
<?php if (!empty($ratioSm) && !empty($bpSm)): ?>
    @media (max-width: <?php echo (int) $bpSm; ?>px) {
      #iiif-sc-<?php echo (int) $blockId; ?> .iiif-sc__bg { aspect-ratio: <?php echo $this->escapeHtml($ratioSm); ?>; }
    }
<?php endif; ?>
  </style>
  <?php if (!empty($customCss)): ?>
    <style>
      /* Custom CSS for #iiif-sc-<?php echo (int) $blockId; ?> */
<?php echo $customCss; ?>
    </style>
  <?php endif; ?>
  <div class="iiif-sc__bg">
    <?php foreach ($rows as $i => $r): ?>
      <?php
        $imgUrl = $r['image_url'] ?? '';
        if ($__hasTrim && is_string($imgUrl) && $imgUrl !== '') {
          // Replace the region segment '/full/' with '/pct:x,y,w,h/'.
          // Be conservative: only replace the first occurrence of '/full/'.
          $pos = strpos($imgUrl, '/full/');
          if ($pos !== false) {
            $imgUrl = substr($imgUrl, 0, $pos + 1) . $__region . '/' . substr($imgUrl, $pos + 6);
          }
        }
      ?>
      <?php
        $href = !empty($r['related_url']) ? $r['related_url'] : null;
        $debugOriginal = $href;
        if (is_string($href)) {
          // Normalize whitespace
          $href = trim($href);
          // Internal token strict patterns
            if (preg_match('/^omeka:media:(\d+)$/', $href, $mm)) {
              $id = (int) $mm[1];
              if ($id > 0) {
                $hrefBuilt = $this->url('site/resource', ['controller' => 'media', 'action' => 'show', 'id' => $id], true);
                if (!preg_match('#/media/\d+(?:$|/)#', $hrefBuilt)) {
                  $site = $this->currentSite();
                  $slug = $site ? $site->slug() : 'site';
                  $hrefBuilt = $this->basePath() . '/s/' . rawurlencode($slug) . '/media/' . $id;
                }
                $href = $hrefBuilt;
              } else { $href = null; }
            }
            elseif (preg_match('/^omeka:item:(\d+)$/', $href, $mi)) {
              $id = (int) $mi[1];
              if ($id > 0) {
                $hrefBuilt = $this->url('site/resource', ['controller' => 'item', 'action' => 'show', 'id' => $id], true);
                if (!preg_match('#/item/\d+(?:$|/)#', $hrefBuilt)) {
                  $site = $this->currentSite();
                  $slug = $site ? $site->slug() : 'site';
                  $hrefBuilt = $this->basePath() . '/s/' . rawurlencode($slug) . '/item/' . $id;
                }
                $href = $hrefBuilt;
              } else { $href = null; }
            }
            // API or pretty item URL (convert to site route)
            elseif (preg_match('#/api/items/(\d+)(?:$|[/?])#', $href, $m)) {
              $id = (int) $m[1];
              $hrefBuilt = $this->url('site/resource', ['controller' => 'item', 'action' => 'show', 'id' => $id], true);
              if (!preg_match('#/item/\d+(?:$|/)#', $hrefBuilt)) {
                $site = $this->currentSite();
                $slug = $site ? $site->slug() : 'site';
                $hrefBuilt = $this->basePath() . '/s/' . rawurlencode($slug) . '/item/' . $id;
              }
              $href = $hrefBuilt;
            }
            elseif (preg_match('#/(?:s/[^/]+/)?item/(\d+)(?:$|[/?])#', $href, $m)) {
              $id = (int) $m[1];
              $hrefBuilt = $this->url('site/resource', ['controller' => 'item', 'action' => 'show', 'id' => $id], true);
              if (!preg_match('#/item/\d+(?:$|/)#', $hrefBuilt)) {
                $site = $this->currentSite();
                $slug = $site ? $site->slug() : 'site';
                $hrefBuilt = $this->basePath() . '/s/' . rawurlencode($slug) . '/item/' . $id;
              }
              $href = $hrefBuilt;
            }
            // Unsafe show pages without id (with optional query/fragment) -> drop
            elseif (preg_match('#/(?:s/[^/]+/)?(?:item|media)/show(?:[?#].*)?$#', $href)) {
              $href = null;
            }
        }
      ?>
      <?php $labelFull = (string) ($r['label'] ?? ''); $labelShort = $__truncate($labelFull); ?>
  <a class="iiif-sc__slide<?php if ($i === 0) echo ' is-active'; ?>"<?php if ($href): ?> href="<?php echo $this->escapeHtml($href); ?>"<?php endif; ?> data-orig="<?php echo $this->escapeHtml($debugOriginal); ?>" data-final="<?php echo $this->escapeHtml((string)$href); ?>" aria-label="<?php echo $this->escapeHtml($labelFull); ?>">
        <img src="<?php echo $this->escapeHtml($imgUrl); ?>" alt="" loading="eager" decoding="async">
        <?php if ($labelFull !== ''): ?>
          <span class="iiif-sc__caption"<?php if ($labelShort !== $labelFull): ?> title="<?php echo $this->escapeHtml($labelFull); ?>"<?php endif; ?>>
            <?php echo $this->escapeHtml($labelShort); ?>
          </span>
        <?php endif; ?>
      </a>
    <?php endforeach; ?>
  </div>

  <?php if (!empty($showSearch)): ?>
    <div class="iiif-sc__overlay">
          <form class="iiif-sc__search search-form search-form--inline" method="get" action="<?php echo $searchAction; ?>" aria-label="Carousel search form">
            <div class="iiif-sc__controls">
              <input type="search" id="multi-search-input" name="search" value="<?php echo $searchValue; ?>" placeholder="<?php echo $this->escapeHtml($__placeholder); ?>" aria-label="Search keywords" pattern=".*\S.*" required class="search-form__input"<?php if ($__isJa): ?> oninvalid="this.setCustomValidity('キーワードを入力してください')" oninput="this.setCustomValidity('')"<?php endif; ?>>
              <fieldset class="multi-search-logic">
                <legend class="show-for-sr">Logic</legend>
                <label class="logic-option">
                  <input type="radio" name="logic" value="and" checked> AND
                </label>
                <label class="logic-option">
                  <input type="radio" name="logic" value="or"> OR
                </label>
              </fieldset>
              <button type="submit" class="button"><?php echo $this->escapeHtml($__buttonLabel); ?></button>
            </div>
        <?php if (!empty($exampleTerms) && is_array($exampleTerms)): ?>
          <?php
            $labelExample = $__isJa ? '例えば：' : 'For example:';
            $controllerMap = [
              'items' => 'item',
              'media' => 'media',
              'item_sets' => 'item-set',
            ];
            $initialTarget = is_array($resourceTargets) && $resourceTargets ? $resourceTargets[0] : 'items';
            $controller = $controllerMap[$initialTarget] ?? 'item';
            $baseUrl = $this->url('site/resource', ['controller' => $controller, 'action' => 'browse'], true);
            $short8 = function ($s) {
              $s = (string) $s;
              if (function_exists('mb_strlen') && function_exists('mb_substr')) {
                return (mb_strlen($s, 'UTF-8') > 8)
                  ? (mb_substr($s, 0, 8, 'UTF-8') . '…')
                  : $s;
              }
              return (strlen($s) > 8) ? (substr($s, 0, 8) . '…') : $s;
            };
          ?>
          <div class="iiif-sc__examples-row">
            <div class="iiif-sc__examples" aria-label="<?php echo $this->escapeHtml($labelExample); ?>">
              <span class="iiif-sc__examples-label"><?php echo $this->escapeHtml($labelExample); ?></span>
              <?php foreach ($exampleTerms as $i => $term): ?>
                <?php
                  $q = (string) $term;
                  $href = $baseUrl . '?search=' . rawurlencode($q);
                  // Remove half-width brackets [] () <> from display only.
                  $qDisplay = preg_replace('/[\[\]\(\)\<\>]/u', '', $q);
                  $display = $short8($qDisplay);
                ?>
                <a class="iiif-sc__example" href="<?php echo $this->escapeHtml($href); ?>" title="<?php echo $this->escapeHtml($q); ?>"><?php echo $this->escapeHtml($display); ?></a>
              <?php endforeach; ?>
            </div>
          </div>
        <?php endif; ?>
        <div id="multi-search-hidden" aria-hidden="true" style="display:none"></div>
      </form>
    </div>
  <?php endif; ?>

  <script>window.IIIF_SC_DURATION=<?php echo (int) $duration; ?>;</script>
</section>
